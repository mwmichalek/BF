@inherits BFComponent;

@using Syncfusion.EJ2.Blazor
@using Syncfusion.EJ2.Blazor.CircularGauge
@using Syncfusion.EJ2.Blazor.Inputs
@using BF.Service.Events
@using BF.Common.Events
@using BF.Common.Components
@using BF.Common.States
@using Microsoft.Extensions.Logging
@using System.Threading

<h2>[ @SetPoint ]</h2>

<div class="content-wrapper" style="height: 100%;">


    <EjsSlider @ref="Slider"
               Orientation="@SliderOrientation.Vertical"
               Type=SliderType.MinRange
               Value="SetPoint"
               Min="40" Max="212">
        <SliderTooltipData IsVisible="true" Placement="TooltipPlacement.Before" ShowOn="TooltipShowOn.Always" />
        <SliderTicksData Placement="Placement.After"
                         ShowSmallTicks="false"
                         LargeStep="10"
                         SmallStep="1" />
        <SliderEvents TValue="int"
                      ValueChange="@SetPoint_ValueChange" />

    </EjsSlider>
</div>

@code {

    public int SetPoint { get; set; } = 60;

    public EjsSlider<int> Slider { get; set; }

    public override void Initialize() {
        _eventHandler.SubscribeToComponentStateChange<PidControllerState>(PidControllerStateChangeOccured,
                                                                          ComponentId,
                                                                          ThreadType.UIThread);
    }

    public void PidControllerStateChangeOccured(ComponentStateChange<PidControllerState> componentStateChange) {
        if (SetPoint != (int)componentStateChange.CurrentState.SetPoint) {
            RepeatUntilComplete(() => {
                SetPoint = (int)componentStateChange.CurrentState.SetPoint;
                return Slider.Value == (int)componentStateChange.CurrentState.SetPoint;
            });
        }
    }

    void SetPoint_ValueChange(SliderChangeEventArgs<int> eventArgs) {
        if (SetPoint != eventArgs.Value) {
            SetPoint = eventArgs.Value;

            _eventHandler.ComponentStateRequestFiring(new ComponentStateRequest<PidControllerRequestState> {
                RequestState = new PidControllerRequestState {
                    Id = ComponentId,
                    SetPoint = eventArgs.Value
                }
            });
        }
    }

}
